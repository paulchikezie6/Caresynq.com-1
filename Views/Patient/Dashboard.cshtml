@model CareSynq.Models.Patient

@{
    ViewData["Title"] = "Patient Dashboard";
}

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary fw-bold">Welcome, @Model.FirstName @Model.LastName</h2>
                    <p class="text-muted">Monitor your pressure readings and stay connected with your care team</p>
                </div>
                <a href="@Url.Action("Logout", "Home")" class="btn btn-outline-danger">Logout</a>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm border-start border-primary border-4">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">Total Readings</h6>
                    <h3 class="fw-bold" id="totalReadings">0</h3>
                    <small class="text-success">?? All time</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-start border-warning border-4">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">High Pressure Alerts</h6>
                    <h3 class="fw-bold text-warning" id="alertCount">0</h3>
                    <small class="text-muted">?? Requires attention</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-start border-success border-4">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">Upcoming Appointments</h6>
                    <h3 class="fw-bold text-success">@Model.Appointments.Count(a => a.AppointmentDate > DateTime.Now && a.Status == "Scheduled")</h3>
                    <small class="text-muted">?? Scheduled</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm border-start border-info border-4">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">Avg Contact Area</h6>
                    <h3 class="fw-bold text-info" id="avgContact">0%</h3>
                    <small class="text-muted">?? Last 24 hours</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Upload & Chart -->
        <div class="col-md-8">
            <!-- CSV Upload Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">?? Upload Sensor Data</h5>
                </div>
                <div class="card-body">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="csvFile" class="form-label">Select CSV File (32x32 pressure matrix)</label>
                            <input type="file" class="form-control" id="csvFile" accept=".csv" required>
                        </div>
                        <button type="submit" class="btn btn-success" id="uploadBtn">
                            <span class="spinner-border spinner-border-sm d-none" id="uploadSpinner"></span>
                            Upload Data
                        </button>
                        <div id="uploadMessage" class="mt-2"></div>
                    </form>
                </div>
            </div>

            <!-- Pressure Chart -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">?? Pressure Readings Over Time</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="loadChartData(1)">1h</button>
                            <button type="button" class="btn btn-outline-primary" onclick="loadChartData(6)">6h</button>
                            <button type="button" class="btn btn-outline-primary active" onclick="loadChartData(24)">24h</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <canvas id="pressureChart" height="100"></canvas>
                </div>
            </div>

            <!-- Recent Readings Table -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">?? Recent Readings</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Timestamp</th>
                                    <th>Peak Pressure</th>
                                    <th>Contact Area</th>
                                    <th>Status</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="readingsTable">
                                <tr>
                                    <td colspan="5" class="text-center text-muted">Loading data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Appointments & Alerts -->
        <div class="col-md-4">
            <!-- Alerts Card -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">?? Active Alerts</h5>
                </div>
                <div class="card-body">
                    <div id="alertsList">
                        <p class="text-muted text-center">No active alerts</p>
                    </div>
                </div>
            </div>

            <!-- Appointments Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">?? Upcoming Appointments</h5>
                </div>
                <div class="card-body">
                    @if (Model.Appointments != null && Model.Appointments.Any(a => a.AppointmentDate > DateTime.Now))
                    {
                        @foreach (var appointment in Model.Appointments.Where(a => a.AppointmentDate > DateTime.Now).OrderBy(a => a.AppointmentDate).Take(5))
                        {
                            <div class="border-start border-success border-4 ps-3 mb-3">
                                <h6 class="fw-bold mb-1">@appointment.AppointmentDate.ToString("MMM dd, yyyy")</h6>
                                <p class="mb-1 text-muted">@appointment.AppointmentDate.ToString("hh:mm tt")</p>
                                <p class="mb-1"><strong>Clinician:</strong> Dr. @appointment.Clinician.LastName</p>
                                <small class="text-muted">@appointment.Notes</small>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center">No upcoming appointments</p>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Comment Modal -->
<div class="modal fade" id="commentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Comment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea id="commentText" class="form-control" rows="4" placeholder="Enter your feedback or notes..."></textarea>
                <input type="hidden" id="commentSensorDataId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitComment()">Submit</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let pressureChart;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initChart();
            loadChartData(24);
            loadTableData();
            
            // Setup upload form
            document.getElementById('uploadForm').addEventListener('submit', handleUpload);
        });

        // Initialize Chart
        function initChart() {
            const ctx = document.getElementById('pressureChart').getContext('2d');
            pressureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Peak Pressure',
                        data: [],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                        label: 'Contact Area %',
                        data: [],
                        borderColor: '#0dcaf0',
                        backgroundColor: 'rgba(13, 202, 240, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Value' } },
                        x: { title: { display: true, text: 'Time' } }
                    }
                }
            });
        }

        // Load chart data
        function loadChartData(hours) {
            fetch(`/Patient/GetSensorData?hours=${hours}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        const labels = result.data.map(d => new Date(d.timestamp).toLocaleTimeString());
                        const peakPressures = result.data.map(d => d.peakPressure);
                        const contactAreas = result.data.map(d => d.contactArea);

                        pressureChart.data.labels = labels;
                        pressureChart.data.datasets[0].data = peakPressures;
                        pressureChart.data.datasets[1].data = contactAreas;
                        pressureChart.update();

                        updateStatistics(result.data);
                    }
                });
        }

        // Update statistics
        function updateStatistics(data) {
            document.getElementById('totalReadings').textContent = data.length;
            
            const alerts = data.filter(d => d.isAlert).length;
            document.getElementById('alertCount').textContent = alerts;

            const avgContact = data.length > 0 
                ? (data.reduce((sum, d) => sum + d.contactArea, 0) / data.length).toFixed(1)
                : 0;
            document.getElementById('avgContact').textContent = avgContact + '%';

            // Show alerts
            const alertsList = document.getElementById('alertsList');
            if (alerts > 0) {
                const alertData = data.filter(d => d.isAlert).slice(0, 5);
                alertsList.innerHTML = alertData.map(a => `
                    <div class="alert alert-warning mb-2 py-2">
                        <small><strong>${new Date(a.timestamp).toLocaleString()}</strong><br>
                        Peak: ${a.peakPressure} | Contact: ${a.contactArea.toFixed(1)}%</small>
                    </div>
                `).join('');
            } else {
                alertsList.innerHTML = '<p class="text-muted text-center">No active alerts</p>';
            }
        }

        // Load table data
        function loadTableData() {
            fetch('/Patient/GetSensorData?hours=24')
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        const table = document.getElementById('readingsTable');
                        if (result.data.length === 0) {
                            table.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No readings available. Upload CSV data to begin.</td></tr>';
                            return;
                        }

                        table.innerHTML = result.data.slice(0, 10).map(d => `
                            <tr>
                                <td>${new Date(d.timestamp).toLocaleString()}</td>
                                <td><span class="badge bg-danger">${d.peakPressure}</span></td>
                                <td><span class="badge bg-info">${d.contactArea.toFixed(1)}%</span></td>
                                <td>
                                    ${d.isAlert 
                                        ? '<span class="badge bg-warning">?? Alert</span>' 
                                        : '<span class="badge bg-success">? Normal</span>'}
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary" onclick="openCommentModal(${d.id})">
                                        ?? Comment
                                    </button>
                                </td>
                            </tr>
                        `).join('');
                    }
                });
        }

        // Handle file upload
        function handleUpload(e) {
            e.preventDefault();
            
            const fileInput = document.getElementById('csvFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showMessage('Please select a file', 'danger');
                return;
            }

            const formData = new FormData();
            formData.append('csvFile', file);

            const btn = document.getElementById('uploadBtn');
            const spinner = document.getElementById('uploadSpinner');
            btn.disabled = true;
            spinner.classList.remove('d-none');

            fetch('/Patient/UploadSensorData', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    showMessage('Data uploaded successfully!', 'success');
                    loadChartData(24);
                    loadTableData();
                    fileInput.value = '';
                } else {
                    showMessage('Upload failed: ' + result.message, 'danger');
                }
            })
            .catch(error => {
                showMessage('Error: ' + error, 'danger');
            })
            .finally(() => {
                btn.disabled = false;
                spinner.classList.add('d-none');
            });
        }

        // Show message
        function showMessage(message, type) {
            const msgDiv = document.getElementById('uploadMessage');
            msgDiv.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>`;
        }

        // Open comment modal
        function openCommentModal(sensorDataId) {
            document.getElementById('commentSensorDataId').value = sensorDataId;
            document.getElementById('commentText').value = '';
            new bootstrap.Modal(document.getElementById('commentModal')).show();
        }

        // Submit comment
        function submitComment() {
            const sensorDataId = document.getElementById('commentSensorDataId').value;
            const commentText = document.getElementById('commentText').value;

            if (!commentText.trim()) {
                alert('Please enter a comment');
                return;
            }

            fetch('/Patient/AddComment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `sensorDataId=${sensorDataId}&commentText=${encodeURIComponent(commentText)}`
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Comment added successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('commentModal')).hide();
                } else {
                    alert('Failed to add comment');
                }
            });
        }
    </script>
}