@model CareSynq.Models.Clinician

@{
    ViewData["Title"] = "Clinician Dashboard";
}

<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-success fw-bold">Clinician Dashboard</h2>
                    <p class="text-muted">Dr. @Model.FirstName @Model.LastName - @Model.Specialization</p>
                </div>
                <a href="@Url.Action("Logout", "Home")" class="btn btn-outline-danger">Logout</a>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Patient List -->
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">👥 Patient List</h5>
                </div>
                <div class="card-body" style="max-height: 600px; overflow-y: auto;">
                    <div class="input-group mb-3">
                        <input type="text" id="searchPatient" class="form-control" placeholder="Search patients...">
                        <button class="btn btn-outline-secondary" onclick="loadPatients()">🔍</button>
                    </div>
                    <div id="patientList">
                        <p class="text-center text-muted">Loading patients...</p>
                    </div>
                </div>
            </div>

            <!-- Upcoming Appointments -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">📅 Your Appointments</h5>
                </div>
                <div class="card-body">
                    @if (Model.Appointments != null && Model.Appointments.Any(a => a.AppointmentDate > DateTime.Now))
                    {
                        @foreach (var appointment in Model.Appointments.Where(a => a.AppointmentDate > DateTime.Now).OrderBy(a => a.AppointmentDate).Take(5))
                        {
                            <div class="border-start border-info border-4 ps-3 mb-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="fw-bold mb-1">@appointment.Patient.FirstName @appointment.Patient.LastName</h6>
                                    <span class="badge bg-@(appointment.Status == "Scheduled" ? "success" : appointment.Status == "Completed" ? "primary" : appointment.Status == "Cancelled" ? "danger" : "secondary")">
                                        @appointment.Status
                                    </span>
                                </div>
                                <p class="mb-1 text-muted">@appointment.AppointmentDate.ToString("MMM dd, yyyy hh:mm tt")</p>
                                <small class="text-muted">@appointment.Notes</small>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-muted text-center">No upcoming appointments</p>
                    }
                </div>
            </div>
        </div>

        <!-- Patient Data Viewer -->
        <div class="col-md-8">
            <div id="noPatientSelected" class="card shadow-sm">
                <div class="card-body text-center py-5">
                    <h3 class="text-muted">👤 Select a patient to view their data</h3>
                    <p class="text-muted">Click on a patient name from the list to review their pressure readings and history</p>
                </div>
            </div>

            <div id="patientDataView" style="display: none;">
                <!-- Patient Info Header -->
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="mb-0" id="selectedPatientName"></h4>
                                <p class="text-muted mb-0" id="selectedPatientEmail"></p>
                            </div>
                            <button class="btn btn-primary" onclick="showAppointmentModal()">
                                📅 Schedule Appointment
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Alert Summary -->
                <div class="row g-3 mb-4">
                    <div class="col-md-4">
                        <div class="card shadow-sm border-start border-danger border-4">
                            <div class="card-body">
                                <h6 class="text-muted">High Pressure Alerts</h6>
                                <h3 class="fw-bold text-danger" id="patientAlertCount">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm border-start border-primary border-4">
                            <div class="card-body">
                                <h6 class="text-muted">Total Readings</h6>
                                <h3 class="fw-bold text-primary" id="patientReadingCount">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card shadow-sm border-start border-success border-4">
                            <div class="card-body">
                                <h6 class="text-muted">Avg Peak Pressure</h6>
                                <h3 class="fw-bold text-success" id="patientAvgPressure">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pressure Chart -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">📊 Pressure Analysis</h5>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="loadPatientData(currentPatientId, 1)">1h</button>
                                <button class="btn btn-outline-primary" onclick="loadPatientData(currentPatientId, 6)">6h</button>
                                <button class="btn btn-outline-primary active" onclick="loadPatientData(currentPatientId, 24)">24h</button>
                                <button class="btn btn-outline-primary" onclick="loadPatientData(currentPatientId, 168)">7d</button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="patientChart" height="80"></canvas>
                    </div>
                </div>

                <!-- Readings with Comments -->
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h5 class="mb-0">📋 Detailed Readings & Comments</h5>
                    </div>
                    <div class="card-body">
                        <div id="readingsWithComments">
                            <p class="text-center text-muted">Loading data...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Appointment Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule Appointment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Patient</label>
                    <input type="text" id="appointmentPatientName" class="form-control" readonly>
                    <input type="hidden" id="appointmentPatientId">
                </div>
                <div class="mb-3">
                    <label class="form-label">Date & Time</label>
                    <input type="datetime-local" id="appointmentDateTime" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea id="appointmentNotes" class="form-control" rows="3" placeholder="Reason for visit, special instructions..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createAppointment()">Schedule</button>
            </div>
        </div>
    </div>
</div>

<!-- Comment Modal -->
<div class="modal fade" id="commentModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Clinical Note</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <textarea id="clinicianCommentText" class="form-control" rows="4" placeholder="Enter your clinical assessment..."></textarea>
                <input type="hidden" id="clinicianCommentSensorDataId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="submitClinicianComment()">Save Note</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        let patientChart;
        let currentPatientId = null;

        document.addEventListener('DOMContentLoaded', function() {
            loadPatients();
            initPatientChart();
        });

        // Load patients
        function loadPatients() {
            fetch('/Clinician/GetPatients')
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const container = document.getElementById('patientList');
                        if (result.patients.length === 0) {
                            container.innerHTML = '<p class="text-muted text-center">No patients found</p>';
                            return;
                        }

                        container.innerHTML = result.patients.map(p => `
                            <div class="patient-item p-3 border-bottom" style="cursor: pointer;" onclick="selectPatient(${p.id}, '${p.name}', '${p.email}')">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-0">${p.name}</h6>
                                        <small class="text-muted">${p.email}</small>
                                    </div>
                                    ${p.hasAlerts ? '<span class="badge bg-warning">⚠️</span>' : ''}
                                </div>
                            </div>
                        `).join('');
                    }
                });
        }

        // Select patient
        function selectPatient(patientId, name, email) {
            currentPatientId = patientId;
            document.getElementById('selectedPatientName').textContent = name;
            document.getElementById('selectedPatientEmail').textContent = email;
            document.getElementById('noPatientSelected').style.display = 'none';
            document.getElementById('patientDataView').style.display = 'block';
            
            loadPatientData(patientId, 24);
        }

        // Initialize chart
        function initPatientChart() {
            const ctx = document.getElementById('patientChart').getContext('2d');
            patientChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Peak Pressure',
                        data: [],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4
                    }, {
                        label: 'Contact Area %',
                        data: [],
                        borderColor: '#0dcaf0',
                        backgroundColor: 'rgba(13, 202, 240, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: true } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        // Load patient data
        function loadPatientData(patientId, hours) {
            fetch(`/Clinician/GetPatientData?patientId=${patientId}&hours=${hours}`)
                .then(response => response.json())
                .then(result => {
                    if (result.success && result.data) {
                        updateChart(result.data);
                        updateStatistics(result.data);
                        displayReadingsWithComments(result.data);
                    }
                });
        }

        // Update chart
        function updateChart(data) {
            const labels = data.map(d => new Date(d.timestamp).toLocaleTimeString());
            const peakPressures = data.map(d => d.peakPressure);
            const contactAreas = data.map(d => d.contactArea);

            patientChart.data.labels = labels;
            patientChart.data.datasets[0].data = peakPressures;
            patientChart.data.datasets[1].data = contactAreas;
            patientChart.update();
        }

        // Update statistics
        function updateStatistics(data) {
            const alerts = data.filter(d => d.isAlert).length;
            document.getElementById('patientAlertCount').textContent = alerts;
            document.getElementById('patientReadingCount').textContent = data.length;

            const avgPressure = data.length > 0
                ? (data.reduce((sum, d) => sum + d.peakPressure, 0) / data.length).toFixed(0)
                : 0;
            document.getElementById('patientAvgPressure').textContent = avgPressure;
        }

        // Display readings with comments
        function displayReadingsWithComments(data) {
            const container = document.getElementById('readingsWithComments');
            
            if (data.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No readings available</p>';
                return;
            }

            container.innerHTML = data.slice(0, 10).map(d => `
                <div class="card mb-3 ${d.isAlert ? 'border-warning' : ''}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1">${new Date(d.timestamp).toLocaleString()}</h6>
                                <span class="badge bg-danger me-2">Peak: ${d.peakPressure}</span>
                                <span class="badge bg-info me-2">Contact: ${d.contactArea.toFixed(1)}%</span>
                                ${d.isAlert ? '<span class="badge bg-warning">⚠️ Alert</span>' : ''}
                            </div>
                            <button class="btn btn-sm btn-outline-success" onclick="openClinicianCommentModal(${d.id})">
                                💬 Add Note
                            </button>
                        </div>
                        ${d.comments && d.comments.length > 0 ? `
                            <div class="mt-3">
                                <strong>Comments:</strong>
                                ${d.comments.map(c => `
                                    <div class="alert alert-light mb-2 py-2">
                                        <small><strong>${c.author}:</strong> ${c.text}<br>
                                        <em class="text-muted">${new Date(c.date).toLocaleString()}</em></small>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Show appointment modal
        function showAppointmentModal() {
            document.getElementById('appointmentPatientId').value = currentPatientId;
            document.getElementById('appointmentPatientName').value = document.getElementById('selectedPatientName').textContent;
            new bootstrap.Modal(document.getElementById('appointmentModal')).show();
        }

        // Create appointment
        function createAppointment() {
            const patientId = document.getElementById('appointmentPatientId').value;
            const dateTime = document.getElementById('appointmentDateTime').value;
            const notes = document.getElementById('appointmentNotes').value;

            if (!dateTime) {
                alert('Please select date and time');
                return;
            }

            fetch('/Clinician/CreateAppointment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `patientId=${patientId}&appointmentDate=${encodeURIComponent(dateTime)}&notes=${encodeURIComponent(notes)}`
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Appointment scheduled successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('appointmentModal')).hide();
                    location.reload(); // Reload to show updated appointments
                } else {
                    alert('Failed to schedule appointment');
                }
            });
        }

        // Open clinician comment modal
        function openClinicianCommentModal(sensorDataId) {
            document.getElementById('clinicianCommentSensorDataId').value = sensorDataId;
            document.getElementById('clinicianCommentText').value = '';
            new bootstrap.Modal(document.getElementById('commentModal')).show();
        }

        // Submit clinician comment
        function submitClinicianComment() {
            const sensorDataId = document.getElementById('clinicianCommentSensorDataId').value;
            const commentText = document.getElementById('clinicianCommentText').value;

            if (!commentText.trim()) {
                alert('Please enter a note');
                return;
            }

            fetch('/Clinician/AddComment', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `sensorDataId=${sensorDataId}&commentText=${encodeURIComponent(commentText)}`
            })
            .then(response => response.json())
            .then(result => {
                if (result.success) {
                    alert('Note added successfully!');
                    bootstrap.Modal.getInstance(document.getElementById('commentModal')).hide();
                    loadPatientData(currentPatientId, 24);
                } else {
                    alert('Failed to add note');
                }
            });
        }
    </script>
}